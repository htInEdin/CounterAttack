# Fail2Ban configuration file
#
# Author: Henry S. Thompson
#  (based on shorewall-ipset-proto6.conf by Eduardo Diaz)
#
# Requires at least ipset version 6 and shorewall version 4.4.5
#
# Enable shorewall to use a blacklist using iptables by creating a
# file /etc/shorewall/blrules and adding
#    DROP:$ALOG net:+shorewall<ipn>-<name> $FW
# for every jail that uses this action, and creating an ipset named
#  shorewall<ipn>-<name>

[Init]
# Option: savedir
# Note: For saving and restorig ipsets
# Values: filepath
savedir = /var/lib/shorewall

[Init?family=inet4]

# Option:  ipn
# Note:    Control which version of command is executed
# Values:  Empty for IPv4 or 6 for IPv6
ipn = 

# Option:  hash
# Note:    Control which type of hashing is required
# Values:  ip for IPv4 or IPv6
hash = ip

# Option: hashsize
# Note: Can be overriden by the banaction option in a jail section
# Values: Powers of 2, default is 1024
hashsize = <hashsize>

# Option: maxelem
# Note: Can be overriden by the banaction option in a jail section
# Values: Number, default is 65536
maxelem = <maxelem>

# Option:  blocktype
# Note:    For use in dynamic blacklisting only
#          See man page of shorewall for options that
#          include drop, logdrop, reject, or logreject
# Values:  STRING
# blocktype = blacklist!

# Option: comment
# Note: Leave this blank to disallow comments
# Values: comment or absent
comment = comment

[Init?family=inet6]

# Option:  ipn
# Note:    Control which version of command is executed
# Values:  Empty for IPv4 or 6 in for of IPv6
ipn = 6

# Option:  hash
# Note:    Control which type of hashing is required
# Values:  ip for IPv4 or IPv6
hash = ip

# Option: hashsize
# Note: Can be overriden by the banaction option in a jail section
# Values: Powers of 2, default is 1024
hashsize = <hashsize6>

# Option: maxelem
# Note: Can be overriden by the banaction option in a jail section
# Values: Number, default is 65536
maxelem = <maxelem6>

# Option:  blocktype
# Note:    For use in dynamic blacklisting only
#          See man page of shorewall for options that
#          include drop, logdrop, reject, or logreject
# Values:  STRING
# blocktype = blacklist!

# Option: comment
# Note: Leave this blank to disallow comments
# Values: comment or absent
comment = comment

[Definition]

# Option:  actionstart
# Notes.:  command executed on demand at the first ban
#         (or at the start of Fail2Ban if actionstart_on_demand is
#          set to false).
#          Creates an appropriate ipset if none exists already
# Values:  CMD
#
actionstart = if ! ipset -quiet -name list shorewall<ipn>-<name> >/dev/null;
              then ipset -quiet -exist create shorewall<ipn>-<name> hash:<hash> family inet<ipn> hashsize <hashsize> maxelem <maxelem> timeout <default-ipsettime> <comment>;
              fi

# Option:  actionstop
# Notes.:  command executed at the stop of jail (or at the end of Fail2Ban)
# Values:  CMD
#
actionstop = ipset -f <savedir>/shorewall<ipn>-<name>_$$.sav ipset save shorewall<ipn>-<name>;
             ipset flush shorewall<ipn>-<name>

# Option:  actionban
# Notes.:  command executed when banning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionban = ipset add shorewall<ipn>-<name> <ip> timeout <ipsettime> -exist

# actionprolong = %(actionban)s

# Option:  actionunban
# Notes.:  command executed when unbanning an IP. Take care that the
#          command is executed with Fail2Ban user rights.
# Tags:    See jail.conf(5) man page
# Values:  CMD
#
actionunban = ipset del shorewall<ipn>-<name> <ip> -exist

# Option: default-ipsettime
# Notes:  specifies default timeout in seconds (handled default ipset timeout only)
# Values:  [ NUM ]  Default: 0 (no timeout, managed by fail2ban by unban)
default-ipsettime = 0

# Option: ipsettime
# Notes:  specifies ticket timeout (handled ipset timeout only)
# Values:  [ NUM ]  Default: 0 (managed by fail2ban by unban)
ipsettime = 0

# expresion to caclulate timeout from bantime, example:
# banaction = %(known/banaction)s[ipsettime='<timeout-bantime>']
timeout-bantime = $([ "<bantime>" -le 2147483 ] && echo "<bantime>" || echo 0)

